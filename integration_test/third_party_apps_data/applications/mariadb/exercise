set -e

# initialize and start replation source
sudo mysql_install_db --defaults-group-suffix=.replica
sudo systemctl start mariadb@replica

mysql1() {
  sudo mysql -Bs "$@"
}

mysql2() {
  mysql1 -S /run/mysqld/mysql2.sock "$@"
}

# Create replication user on primary
mysql1 -e "CREATE USER 'repl'@'localhost' IDENTIFIED BY 'password';"
mysql1 -e "GRANT REPLICATION SLAVE ON *.* TO 'repl'@'localhost';"

# Dump data from replica source
sudo mysqldump --all-databases --apply-slave-statements --master-data | \
  sed "s/^\(CHANGE MASTER TO\)/\1 MASTER_HOST='localhost', MASTER_USER='repl', MASTER_PASSWORD='password', /" | \
  mysql2

# Run a simple query that we can see in the logs.
mysql1 -D information_schema -e "select table_catalog, table_schema, table_name from information_schema.tables"
