set -e

cat <<EOF > config-user
[client]
user=root
password='Ss123%321'
EOF

cat <<EOF > config-user-2
[client]
user=root
password='Ss123%322'
EOF

# initialize and start replation source
sudo mysql_install_db --defaults-group-suffix=2
nohup sudo mysqld --defaults-group-suffix=2 2>/dev/null >/dev/null </dev/null &
# give it time to start, since we put it in the background
sleep 10

sudo mysql --defaults-extra-file=config-user-2 -S /var/run/mysqld/mysql2.sock -Bse "ALTER USER 'root'@'localhost' IDENTIFIED VIA mysql_native_password USING PASSWORD('Ss123%321'); FLUSH PRIVILEGES;" --connect-expired-password

# Create replication user
sudo mysql --defaults-extra-file=config-user -S /var/run/mysqld/mysql2.sock -Bse "CREATE USER 'repl'@'localhost' IDENTIFIED BY 'password';"
sudo mysql --defaults-extra-file=config-user -S /var/run/mysqld/mysql2.sock -Bse "GRANT REPLICATION SLAVE ON *.* TO 'repl'@'localhost';"

# Dump data from replica source
sudo mysqldump --defaults-extra-file=config-user -S /var/run/mysqld/mysql2.sock --all-databases --master-data > /tmp/dbdump.sql

# Capture status to seed replica
raw_status=$(sudo mysql --defaults-extra-file=config-user -S /var/run/mysqld/mysql2.sock -Bse "SHOW MASTER STATUS;")
read -r logfile logpos <<< $raw_status

# Dump data from source into replica
sudo mysql --defaults-extra-file=config-user < /tmp/dbdump.sql

# Configure replication
sudo mysql --defaults-extra-file=config-user -Bse "STOP REPLICA;"
sudo mysql --defaults-extra-file=config-user -Bse "CHANGE MASTER TO MASTER_HOST='localhost', MASTER_USER='repl', MASTER_PORT=3307, MASTER_PASSWORD='password', MASTER_LOG_FILE='$logfile', MASTER_LOG_POS=$logpos;"
sudo mysql --defaults-extra-file=config-user -Bse "START REPLICA;"

sudo mysql --defaults-extra-file=config-user -Bse "SET GLOBAL long_query_time = 0"
sudo mysql --defaults-extra-file=config-user -Bse "SET GLOBAL slow_query_log = 1"
sudo mysql --defaults-extra-file=config-user -Bse "SET GLOBAL general_log = 'ON'"

sudo mysql --defaults-extra-file=config-user -Bse "select table_catalog, table_schema, table_name from information_schema.tables"