set -e

sudo apt update
sudo apt install -y \
  mariadb-server

# See the comment block in /lib/systemd/system/mariadb@.service for
# information on how to configure multiple mysql instances on the same
# machine.

# set up replication source to validate replica metrics
# set main target (replica) to use binary logging for replication to work
sudo tee /etc/mysql/mariadb.conf.d/99-replicas.cnf >/dev/null <<EOF
[mysqld]
general-log
slow-query-log
long-query-time = 0

server-id = 1
log-bin

[mysqld.replica]
pid-file = /run/mysqld/mysqld2.pid
socket = /run/mysqld/mysql2.sock
port = 3307
user = mysql
datadir = /var/lib/mysql2/
server-id = 2
log-bin
EOF

# prepare config and data permissions
sudo mkdir /var/lib/mysql2
sudo chown mysql:mysql /var/lib/mysql2/

# start primary instance; replica will be started by the exercise script.
sudo systemctl restart mariadb
