set -e
set -o pipefail

sudo apt-get update

# All other tested distributions have default-jre point to openjdk-11-jre, but default-jre pulls in openjdk-17-jre
# for Ubuntu 23.04, and HBase does not currently support Java 17 (see https://hbase.apache.org/book.html#java)
source /etc/os-release
if [[ "${VERSION_ID}" == 12 ]]; then
    sudo apt-get install -y openjdk-17-jre wget
else
    sudo apt-get install -y openjdk-11-jre wget
if

HBASE_VERSION=2.4.11

sudo mkdir /opt/hbase
# https://github.com/GoogleCloudPlatform/ops-agent/blob/master/integration_test/README.md#vendored-dependencies
wget --no-verbose https://storage.googleapis.com/ops-agents-public-buckets-vendored-deps/mirrored-content/archive.apache.org/dist/hbase/"$HBASE_VERSION"/hbase-"$HBASE_VERSION"-bin.tar.gz
sudo tar -xvf hbase-"$HBASE_VERSION"-bin.tar.gz -C /opt/hbase --strip 1

sudo tee /opt/hbase/conf/hbase-env.sh <<EOF
export HBASE_JMX_BASE="-Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false"
export HBASE_MASTER_OPTS="\$HBASE_MASTER_OPTS \$HBASE_JMX_BASE -Dcom.sun.management.jmxremote.rmi.port=10101 -Dcom.sun.management.jmxremote.port=10101"
EOF
sudo chmod +x /opt/hbase/conf/hbase-env.sh

JAVA_HOME="$(dirname "$(dirname "$(readlink "$(readlink "$(which java)")")")")"
export JAVA_HOME

sudo --preserve-env=JAVA_HOME /opt/hbase/bin/start-hbase.sh

sleep 30
