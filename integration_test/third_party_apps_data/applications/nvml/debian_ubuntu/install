# Installs the application
set -e

sudo apt update
kernel_version=`uname -r`
sudo apt install -y linux-headers-${kernel_version} software-properties-common pciutils gcc make dkms wget

# Install CUDA and driver together, since the `exercise` script needs CUDA to compile the application to generating GPU process metrics
DEVICE_CODE=$(lspci -n | grep -Po '10de:[\w\d]{4}')
case $DEVICE_CODE in
    10de:102d)
        # Install a specific version for NVIDIA Tesla K80, R470 is the last supported version
        DRIVER_VERSION=470.82.01
        echo "Installing NVIDIA CUDA 11.2.1 with driver $DRIVER_VERSION"
        curl -fSsl -O https://us.download.nvidia.com/tesla/$DRIVER_VERSION/NVIDIA-Linux-x86_64-$DRIVER_VERSION.run
        sudo bash ./NVIDIA-Linux-x86_64-$DRIVER_VERSION.run --silent
        wget --no-verbose https://developer.download.nvidia.com/compute/cuda/11.4.4/local_installers/cuda_11.4.4_${DRIVER_VERSION}_linux.run
        sudo sh cuda_11.4.4_${DRIVER_VERSION}_linux.run --toolkit --silent
        ;;
    *)
        echo "Installing latest version of NVIDIA CUDA and driver"
        wget --no-verbose https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-keyring_1.0-1_all.deb
        sudo dpkg -i cuda-keyring_1.0-1_all.deb
        sudo apt update
        sudo apt -y install cuda 
        ;;
esac

# check NVIDIA driver installation succeeded
nvidia-smi
