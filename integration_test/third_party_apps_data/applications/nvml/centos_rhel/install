set -e
KERNEL_VERSION=`uname -r`

# sudo yum install -y kernel-devel-${KERNEL_VERSION} pciutils gcc make wget yum-utils 
# TODO(b/312455563): Temporary fix for Rocky Linux 9.2/8.8; uncomment the above line and remove this following section once the image has been updated to Rocky Linux 9.3/8.9
source /etc/os-release
sudo yum install -y pciutils gcc make wget yum-utils
if ! sudo yum install -y kernel-devel-${KERNEL_VERSION}; then 
    sudo yum install -y kernel-devel  # Install the latest kernel dev package first to bring in the dependencies, before switching to 9.2 vault repo
    if [[ $ID == rocky && "${VERSION_ID}" == 9.2 ]]; then
        sudo sed -i 's,mirrorlist=https://mirrors.rockylinux.org/mirrorlist?arch=$basearch&repo=AppStream-$releasever$rltype,baseurl=https://dl.rockylinux.org/vault/rocky/9.2/AppStream/x86_64/os/,g' /etc/yum.repos.d/rocky.repo
    elif [[ $ID == rocky && "${VERSION_ID}" == 8.8 ]]; then
        # Right now the Rocky Linux 8.8 packages are still in the main repo, and the vault repo is returning 403;
        # It can move to the vault repo (archive repo) anytime and then the main repo will become unaccessable.
        VAULT_STATUS=`curl -s -o /dev/null -w "%{http_code}" https://dl.rockylinux.org/vault/rocky/8.8/BaseOS/x86_64/os/`
        if [[ $VAULT_STATUS == 403 ]]; then
            sudo sed -i 's,mirrorlist=https://mirrors.rockylinux.org/mirrorlist?arch=$basearch&repo=BaseOS-$releasever,baseurl=https://download.rockylinux.org/pub/rocky/8.8/BaseOS/x86_64/os,g' /etc/yum.repos.d/Rocky-BaseOS.repo
        else
            sudo sed -i 's,mirrorlist=https://mirrors.rockylinux.org/mirrorlist?arch=$basearch&repo=BaseOS-$releasever,baseurl=https://dl.rockylinux.org/vault/rocky/8.8/BaseOS/x86_64/os/,g' /etc/yum.repos.d/Rocky-BaseOS.repo
        fi
    fi
    sudo yum clean all 
    sudo yum --showduplicates list available kernel-devel
    sudo yum install -y kernel-devel-${KERNEL_VERSION}
fi
# End of the temporary fix

# Install CUDA and driver together, since the `exercise` script needs to run a 
# CUDA sample app to generating GPU process metrics
# Prefer to install from the package manager since it is normally faster and has
# less errors on installation; fallback to the runfile method if the package 
# manager's package is not working or not compitible with the GPU model
DEVICE_CODE=$(lspci -n | grep -Po '10de:[\w\d]{4}')
case $DEVICE_CODE in
    10de:102d)
        # Install a specific version for NVIDIA Tesla K80, R470 is the last supported version
        DRIVER_VERSION=470.82.01
        CUDA_VERSION=11.4.4
        ;;
    *)
        # Installing latest version of NVIDIA CUDA and driver
        DRIVER_VERSION=535.104.05
        CUDA_VERSION=12.2.2
        ;;
esac

echo "Installing NVIDIA CUDA $CUDA_VERSION with driver $DRIVER_VERSION"
curl -fSsl -O https://us.download.nvidia.com/tesla/$DRIVER_VERSION/NVIDIA-Linux-x86_64-$DRIVER_VERSION.run
sudo bash ./NVIDIA-Linux-x86_64-$DRIVER_VERSION.run --silent
wget --no-verbose https://developer.download.nvidia.com/compute/cuda/$CUDA_VERSION/local_installers/cuda_${CUDA_VERSION}_${DRIVER_VERSION}_linux.run
sudo sh cuda_${CUDA_VERSION}_${DRIVER_VERSION}_linux.run --toolkit --silent

# check NVIDIA driver installation succeeded
nvidia-smi
