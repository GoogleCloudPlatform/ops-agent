set -e

source /etc/os-release
MAJOR_VERSION_ID=${VERSION_ID%%.*}

if [[ "$MAJOR_VERSION_ID" == "10" ]]; then
    # Specific fix for EL10 where the 2023 key expired in Oct 2025
    sudo rpm --import https://repo.mysql.com/RPM-GPG-KEY-mysql-2025
else
    # Maintain existing behavior for RHEL 7, 8, and 9
    sudo rpm --import https://repo.mysql.com/RPM-GPG-KEY-mysql-2023
    sudo rpm --import https://repo.mysql.com/RPM-GPG-KEY-mysql-2022
fi

MYSQL_VERSION="mysql80"
if [[ "$ID" == "rocky" && "$MAJOR_VERSION_ID" == "10" ]]; then
  MYSQL_VERSION=mysql84
fi

sudo yum -y install https://repo.mysql.com/${MYSQL_VERSION}-community-release-el${MAJOR_VERSION_ID}.rpm

if [ ${MAJOR_VERSION_ID} == 8 ]; then
  sudo yum -y module disable mysql
fi
sudo yum -y install mysql-community-server

# Handle authentication plugin configuration
if [[ "$MYSQL_VERSION" == "mysql84" ]]; then
  # For MySQL 8.4+, we use the default (caching_sha2_password)
  echo "# Using default caching_sha2_password for RHEL 10" | sudo tee -a /etc/my.cnf
else
  # Maintain existing behavior for MySQL 8.0
  echo "default-authentication-plugin=mysql_native_password" | sudo tee -a /etc/my.cnf
fi

sudo service mysqld start

# Robust password extraction: grab the LAST 'temporary password' entry in the log
password=$(sudo grep 'temporary password' /var/log/mysqld.log | awk '{print $NF}' | tail -n 1)

cat <<EOF > config-user
[client]
user=root
password='$password'
EOF

# Update root password logic
if [[ "$MYSQL_VERSION" == "mysql84" ]]; then
  # Use default plugin for MySQL 8.4+. 
  # If the first attempt fails (Access Denied), check if the password was already set to the target.
  mysql --defaults-extra-file=config-user -Bse "ALTER USER 'root'@'localhost' IDENTIFIED BY 'Ss123%321'; FLUSH PRIVILEGES;" --connect-expired-password || \
  mysql -u root -p'Ss123%321' -Bse "SELECT 1;" && echo "Password already set to Ss123%321"
else
  # Use native password for older versions
  mysql --defaults-extra-file=config-user -Bse "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'Ss123%321'; FLUSH PRIVILEGES;" --connect-expired-password
fi

# default socket path is different from originally set default (from debian/ubuntu), so we need to create a symlink
sudo ln -sf /var/lib/mysql/mysql.sock /var/run/mysqld/mysqld.sock

sudo mkdir -p /var/log/mysql
sudo chown mysql:mysql /var/log/mysql

# Required to allow mysql to accept connections on 3307
if [ ${ID} == rocky ]; then
  sudo yum install -y policycoreutils-python-utils
else
  sudo yum install -y policycoreutils-python
fi

# Add port 3307 to SELinux, ignoring error if it already exists
sudo semanage port --add --type mysqld_port_t --proto tcp 3307 || echo "Port 3307 already added to SELinux"

# set up replication source to validate replica metrics
sudo tee -a /etc/my.cnf >/dev/null <<EOF
server-id = 1
log-bin = /var/log/mysql/mysql-bin.log

[mysqld2]
pid-file = /var/run/mysqld/mysql2.pid
socket = /var/run/mysqld/mysql2.sock
port = 3307
user = mysql
datadir = /var/lib/mysql2/
log-error = /var/log/mysql/error2.log
server-id = 2
log-bin = /var/log/mysql/mysql2-bin.log
EOF

sudo service mysqld restart