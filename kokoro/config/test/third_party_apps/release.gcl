import 'common.gcl' as common
import '../image_lists.gcl' as image_lists
import '../image_lists_3p_override.gcl' as image_lists_3p_override

_parse_louhi_tag = lambda tag: {
  parts = split(tag, '/')
  ret = {
    distro = parts[3]
    arch = parts[4]
  }
}.ret

config build = common.ops_agent_test {
  params {
    local _tag = _parse_louhi_tag(params.environment._LOUHI_TAG_NAME)
    local _distro_arch = _tag.distro + '_' + _tag.arch
    // Default to `3p_override` and fall back to `image_lists` if there's no entry.
    platforms = image_lists_3p_override.get(_distro_arch, image_lists.get(_distro_arch, 'invalid_distro')).release
    arch = _tag.arch

    environment {
      // Disable -test.short mode when testing nightly releases.
      SHORT = null

      // The release builds run as a different service account.
      TRANSFERS_BUCKET = 'stackdriver-test-143416-file-transfers'
      SERVICE_EMAIL =
          'build-and-test@stackdriver-test-143416.iam.gserviceaccount.com'
    }
  }
}