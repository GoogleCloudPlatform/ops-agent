FROM ubuntu:focal AS mingw-build

RUN set -x; apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get -y install git \
    autoconf libtool libltdl-dev \
    build-essential cmake bison flex file \
    devscripts cdbs openjdk-11-jdk zip \
    mingw-w64

ADD https://golang.org/dl/go1.19.linux-amd64.tar.gz /tmp/go1.19.linux-amd64.tar.gz
RUN set -xe; \
    tar -xf /tmp/go1.19.linux-amd64.tar.gz -C /usr/local

RUN export PATH=/usr/local/go/bin:$PATH; \
    go install github.com/google/googet/v2/goopack@latest;

WORKDIR /src
RUN git clone https://github.com/openssl/openssl.git --branch OpenSSL_1_1_1q; \
    cd openssl; \
    ./Configure --cross-compile-prefix=x86_64-w64-mingw32- --prefix=/usr/share/mingw-w64 --libdir=/usr/lib/mingw-w64 mingw64; \
    make; \
    make install

COPY . /work
WORKDIR /work
RUN patch -d ./submodules/fluent-bit/ -p 1 <./pkg/goo/mingw64-support.patch || true
RUN ./pkg/goo/build.sh

FROM scratch as mingw
COPY --from=mingw-build /tmp/google-cloud-ops-agent.tgz /google-cloud-ops-agent-windows-ltsc2019.tgz
COPY --from=mingw-build /google-cloud-ops-agent*.goo /
